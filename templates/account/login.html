{% extends 'base.html' %}
{% load allauth %}

{% block title %}Sign In - HeroesAndMore{% endblock %}

{% block content %}
<div class="min-vh-100 d-flex align-items-center" style="background: var(--gray-50);">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-5 col-lg-4">
                <div class="text-center mb-4">
                    <a href="{% url 'home' %}" class="text-decoration-none">
                        <span style="font-size: 1.75rem; font-weight: 800; color: var(--gray-900);">HEROESANDMORE</span>
                    </a>
                </div>

                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="fw-bold text-center mb-4">Welcome back</h4>

                        {% if form.errors %}
                        <div class="alert alert-danger small">
                            Please correct the errors below.
                        </div>
                        {% endif %}

                        <form method="post" action="{% url 'account_login' %}">
                            {% csrf_token %}

                            <div class="mb-3">
                                <label for="id_login" class="form-label">Email or Username</label>
                                <input type="text" name="login" id="id_login" class="form-control {% if form.login.errors %}is-invalid{% endif %}"
                                       placeholder="Enter your email or username" required
                                       inputmode="email" autocomplete="username" autocapitalize="none" autocorrect="off">
                                {% if form.login.errors %}
                                <div class="invalid-feedback">{{ form.login.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <label for="id_password" class="form-label">Password</label>
                                    <a href="{% url 'account_reset_password' %}" class="small text-muted">Forgot password?</a>
                                </div>
                                <input type="password" name="password" id="id_password" class="form-control {% if form.password.errors %}is-invalid{% endif %}"
                                       placeholder="Enter your password" required
                                       autocomplete="current-password">
                                {% if form.password.errors %}
                                <div class="invalid-feedback">{{ form.password.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-4">
                                <div class="form-check">
                                    <input type="checkbox" name="remember" id="id_remember" class="form-check-input">
                                    <label for="id_remember" class="form-check-label small">Remember me</label>
                                </div>
                            </div>

                            {% if redirect_field_value %}
                            <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}">
                            {% endif %}

                            <button type="submit" class="btn btn-dark w-100 py-2 fw-semibold">
                                Sign In
                            </button>
                        </form>

                        {% comment %}
                        <div class="divider my-4">
                            <span class="text-muted small bg-white px-3">or continue with</span>
                        </div>

                        <div class="d-grid gap-2">
                            <a href="{% provider_login_url 'google' %}" class="btn btn-outline-dark">
                                <i class="bi bi-google me-2"></i> Google
                            </a>
                        </div>
                        {% endcomment %}
                    </div>
                </div>

                <p class="text-center mt-4 text-muted">
                    Don't have an account? <a href="{% url 'account_signup' %}" class="fw-semibold text-dark">Sign up</a>
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .divider {
        display: flex;
        align-items: center;
        text-align: center;
    }
    .divider::before,
    .divider::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid var(--gray-200);
    }
    /* Ensure inputs are interactive on iOS/mobile */
    #id_login, #id_password {
        -webkit-user-select: text !important;
        user-select: text !important;
        pointer-events: auto !important;
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        opacity: 1 !important;
    }
    /* Fix iOS input focus issues */
    .card {
        -webkit-overflow-scrolling: touch;
    }
</style>
<script>
// iOS keyboard fix - Safari requires synchronous focus during user tap
document.addEventListener('DOMContentLoaded', function() {
    var inputs = document.querySelectorAll('#id_login, #id_password');
    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

    if (isIOS) {
        inputs.forEach(function(input) {
            // On iOS, we need to handle the tap event directly
            input.addEventListener('touchstart', function(e) {
                // Store reference for touchend
                this.dataset.touched = 'true';
            }, {passive: true});

            input.addEventListener('touchend', function(e) {
                if (this.dataset.touched === 'true') {
                    this.dataset.touched = 'false';
                    // Focus must happen synchronously in the event handler for iOS
                    this.focus();
                    // Move cursor to end
                    if (this.setSelectionRange) {
                        var len = this.value.length;
                        this.setSelectionRange(len, len);
                    }
                }
            }, {passive: true});
        });
    }
});
</script>
{% endblock %}
