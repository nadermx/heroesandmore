{% extends 'base.html' %}
{% load humanize %}
{% load seo_tags %}
{% load static %}

{% block meta_description %}Buy, sell, and collect trading cards, comics, action figures, and more on HeroesAndMore. Track collection values, browse price guides, and join thousands of collectors.{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "HeroesAndMore",
  "url": "{{ site_url }}",
  "logo": "{% absolute_static 'images/logo-transparent.png' %}",
  "description": "The Premium Collectables Marketplace and Auction House",
  "sameAs": []
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "HeroesAndMore",
  "url": "{{ site_url }}",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "{{ site_url }}/items/search/?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero">
    <div class="container position-relative">
        <div class="row align-items-center">
            <div class="col-lg-7">
                <p class="text-uppercase fw-semibold mb-3" style="color: var(--gray-400); letter-spacing: 0.1em; font-size: 0.85rem;">The Premium Collectables Marketplace and Auction House</p>
                <h1>Buy. Sell. Collect.</h1>
                <p class="lead mb-4">Join thousands of collectors trading cards, comics, figures, and more. Track your collection's value and discover rare finds.</p>
                <div class="d-flex flex-wrap gap-3">
                    <a href="{% url 'marketplace:listing_list' %}" class="btn btn-light btn-lg">
                        Explore Marketplace
                    </a>
                    {% if not user.is_authenticated %}
                    <a href="{% url 'account_signup' %}" class="btn btn-outline-light btn-lg">
                        Create Free Account
                    </a>
                    {% else %}
                    <a href="{% url 'marketplace:listing_create' %}" class="btn btn-outline-light btn-lg">
                        <i class="bi bi-plus-lg me-2"></i>List an Item
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-5 d-none d-lg-block text-end">
                <div class="position-relative">
                    <!-- Logo watermark behind cards -->
                    <img src="{% static 'images/logo-transparent.png' %}" alt="" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; height: auto; opacity: 0.08; pointer-events: none; z-index: 0;">
                    <!-- Floating cards visual -->
                    <div class="d-flex justify-content-end gap-3" style="position: relative; z-index: 1;">
                        <div style="width: 140px; height: 190px; background: linear-gradient(135deg, #E63946 0%, #C62D39 100%); border-radius: 12px; transform: rotate(-6deg); box-shadow: 0 25px 50px rgba(0,0,0,0.3);"></div>
                        <div style="width: 140px; height: 190px; background: linear-gradient(135deg, #00B4D8 0%, #48CAE4 100%); border-radius: 12px; transform: rotate(3deg) translateY(-20px); box-shadow: 0 25px 50px rgba(0,0,0,0.3);"></div>
                        <div style="width: 140px; height: 190px; background: linear-gradient(135deg, #FFB703 0%, #FFC733 100%); border-radius: 12px; transform: rotate(-2deg) translateY(10px); box-shadow: 0 25px 50px rgba(0,0,0,0.3);"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Stats Bar -->
{% if stat_active_listings or stat_collectors %}
<section class="stats-bar d-none d-md-block">
    <div class="container">
        <div class="row">
            <div class="col-3">
                <div class="stat-item">
                    <div class="stat-value">{{ stat_active_listings|intcomma }}</div>
                    <div class="stat-label">Active Listings</div>
                </div>
            </div>
            <div class="col-3">
                <div class="stat-item">
                    <div class="stat-value">{{ stat_collectors|intcomma }}</div>
                    <div class="stat-label">Collectors</div>
                </div>
            </div>
            <div class="col-3">
                <div class="stat-item">
                    <div class="stat-value">${{ stat_sold_total|intcomma }}</div>
                    <div class="stat-label">Items Sold</div>
                </div>
            </div>
            <div class="col-3">
                <div class="stat-item">
                    <div class="stat-value">{% if stat_avg_rating %}{{ stat_avg_rating }}{% else %}-{% endif %}</div>
                    <div class="stat-label">Avg Rating</div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Official Platform Auctions — Prime Position -->
{% if platform_events %}
<section class="section" style="background: linear-gradient(135deg, #0d1117 0%, #1a1a2e 50%, #16213e 100%); color: #fff; padding: 3rem 0;">
    <div class="container">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
            <h2 class="mb-0" style="font-size: 1.5rem; font-weight: 700; color: #fff;">
                <i class="bi bi-shield-check" style="color: #D4A017;"></i>
                Official Auctions
            </h2>
            <a href="{% url 'marketplace:platform_auctions' %}" class="btn btn-outline-light btn-sm">View All Events</a>
        </div>

        {% for event in platform_events %}
        {% if forloop.first %}
        <!-- Featured Event — Hero Banner (entire banner is clickable) -->
        <a href="{{ event.get_absolute_url }}" class="d-block rounded-3 overflow-hidden mb-4 text-decoration-none" style="position: relative; {% if event.cover_image %}background: #000;{% else %}background: linear-gradient(135deg, var(--brand-primary) 0%, #0d1117 100%);{% endif %} transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 30px rgba(0,0,0,0.4)';" onmouseout="this.style.transform='';this.style.boxShadow='';">
            {% if event.cover_image %}
            <img src="{{ event.cover_image.url }}" alt="{{ event.name }}" style="width: 100%; height: 280px; object-fit: cover; object-position: {{ event.cover_image_position_x }}% {{ event.cover_image_position_y }}%; opacity: 0.6;">
            {% else %}
            <div style="height: 280px;"></div>
            {% endif %}
            <div style="position: absolute; inset: 0; display: flex; align-items: center; padding: 2rem;">
                <div style="max-width: 600px;">
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                        {% if event.is_live %}
                        <span class="badge bg-danger px-2 py-1"><i class="bi bi-broadcast me-1"></i> Live Now</span>
                        {% elif event.accepting_submissions %}
                        <span class="badge px-2 py-1" style="background: #D4A017; color: #fff;"><i class="bi bi-send me-1"></i> Submissions Open</span>
                        {% else %}
                        <span class="badge bg-info text-white px-2 py-1">Upcoming</span>
                        {% endif %}
                        <span class="badge bg-warning text-dark px-2 py-1"><i class="bi bi-shield-check"></i> Official</span>
                    </div>
                    <h3 class="fw-bold mb-2" style="color: #fff; font-size: 1.75rem;">{{ event.name }}</h3>
                    {% if event.description %}
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">{{ event.description|truncatewords:25 }}</p>
                    {% endif %}
                    <div class="d-flex flex-wrap align-items-center gap-3 mb-3" style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">
                        {% if event.total_lots %}
                        <span><i class="bi bi-collection me-1"></i> {{ event.total_lots }} lot{{ event.total_lots|pluralize }}</span>
                        {% endif %}
                        {% if event.is_live %}
                        <span class="text-danger fw-bold"><i class="bi bi-clock me-1"></i> Ends {{ event.bidding_end|naturaltime }}</span>
                        {% elif event.accepting_submissions and event.submission_deadline %}
                        <span><i class="bi bi-clock me-1"></i> Submit by {{ event.submission_deadline|date:"M d" }}</span>
                        {% else %}
                        <span><i class="bi bi-clock me-1"></i> Starts {{ event.bidding_start|naturaltime }}</span>
                        {% endif %}
                    </div>
                    <span class="btn btn-light"><i class="bi bi-eye me-1"></i> View Event</span>
                </div>
            </div>
        </a>
        {% else %}
        {% if forloop.counter == 2 %}
        <div class="row g-3">
        {% endif %}
            <!-- Additional Events as Cards -->
            <div class="col-md-6">
                <div class="rounded-3 overflow-hidden h-100" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="d-flex h-100">
                        {% if event.cover_image %}
                        <div style="width: 140px; flex-shrink: 0;">
                            <img src="{{ event.cover_image.url }}" alt="{{ event.name }}" style="width: 100%; height: 100%; object-fit: cover; object-position: {{ event.cover_image_position_x }}% {{ event.cover_image_position_y }}%;">
                        </div>
                        {% endif %}
                        <div class="p-3 d-flex flex-column justify-content-center">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                {% if event.is_live %}
                                <span class="badge bg-danger" style="font-size: 0.7rem;">Live</span>
                                {% elif event.accepting_submissions %}
                                <span class="badge" style="background: #D4A017; color: #fff; font-size: 0.7rem;">Submissions Open</span>
                                {% else %}
                                <span class="badge bg-info text-white" style="font-size: 0.7rem;">Upcoming</span>
                                {% endif %}
                            </div>
                            <h6 class="fw-bold mb-1" style="color: #fff;">
                                <a href="{{ event.get_absolute_url }}" class="text-decoration-none text-white">{{ event.name }}</a>
                            </h6>
                            <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
                                {% if event.is_live %}
                                <i class="bi bi-clock"></i> Ends {{ event.bidding_end|naturaltime }}
                                {% else %}
                                <i class="bi bi-clock"></i> {{ event.bidding_start|date:"M d, Y" }}
                                {% endif %}
                                {% if event.total_lots %} &middot; {{ event.total_lots }} lot{{ event.total_lots|pluralize }}{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% if forloop.last %}
        </div>
        {% endif %}
        {% endif %}
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Ending Soon — FOMO Grid -->
{% if ending_soon %}
<section class="section section-alt">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-clock" style="color: var(--accent-warning);"></i>
                Ending Soon &mdash; Don't Miss Out
            </h2>
            <a href="{% url 'marketplace:listing_list' %}?type=auction&sort=ending" class="btn btn-outline-dark btn-sm">All Auctions</a>
        </div>
        <div class="row g-4">
            {% for listing in ending_soon %}
            <div class="col-6 col-md-4 col-lg-3">
                {% include 'components/listing_card.html' with listing=listing show_time=True %}
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Featured Lots (Recently Listed) -->
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Featured Lots</h2>
            <a href="{% url 'marketplace:listing_list' %}?sort=newest" class="btn btn-outline-dark btn-sm">View All</a>
        </div>
        <div class="row g-4">
            {% for listing in recent_listings %}
            <div class="col-6 col-md-4 col-lg-3 col-xl-2">
                {% include 'components/listing_card.html' with listing=listing %}
            </div>
            {% empty %}
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                    </div>
                    <h5>No listings yet</h5>
                    <p class="text-muted mb-4">Be the first to list an item on the marketplace.</p>
                    <a href="{% url 'marketplace:listing_create' %}" class="btn btn-dark">Create Listing</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Bid Wars Happening Now -->
{% if bid_wars %}
<section class="section" style="background: linear-gradient(180deg, var(--gray-50) 0%, #fff 100%);">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-lightning-fill" style="color: var(--brand-primary);"></i>
                Bid Wars Happening Now
            </h2>
        </div>
        <div class="row g-4">
            {% for listing in bid_wars %}
            <div class="col-6 col-md-4 col-lg-2">
                <div class="bid-war-card">
                    {% include 'components/listing_card.html' with listing=listing show_time=True %}
                    <div class="bid-war-overlay">
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-lightning-fill"></i> +{{ listing.recent_bids }} bids
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Browse Categories -->
<section class="section section-alt">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Browse Categories</h2>
            <a href="{% url 'items:category_list' %}" class="btn btn-outline-dark btn-sm">View All</a>
        </div>
        <div class="row g-3">
            {% for category in categories %}
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <a href="{{ category.get_absolute_url }}" class="category-card h-100">
                    <i class="bi {{ category.icon|default:'bi-box' }} icon"></i>
                    <span class="name">{{ category.name }}</span>
                </a>
            </div>
            {% empty %}
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <a href="#" class="category-card h-100">
                    <i class="bi bi-suit-spade icon"></i>
                    <span class="name">Trading Cards</span>
                </a>
            </div>
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <a href="#" class="category-card h-100">
                    <i class="bi bi-book icon"></i>
                    <span class="name">Comics</span>
                </a>
            </div>
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <a href="#" class="category-card h-100">
                    <i class="bi bi-person-standing icon"></i>
                    <span class="name">Action Figures</span>
                </a>
            </div>
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <a href="#" class="category-card h-100">
                    <i class="bi bi-controller icon"></i>
                    <span class="name">Video Games</span>
                </a>
            </div>
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <a href="#" class="category-card h-100">
                    <i class="bi bi-vinyl icon"></i>
                    <span class="name">Funko Pops</span>
                </a>
            </div>
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                <a href="#" class="category-card h-100">
                    <i class="bi bi-currency-dollar icon"></i>
                    <span class="name">Coins</span>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Curated for Serious Collectors -->
{% if curated_listings %}
<section class="section">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-gem" style="color: var(--brand-gold);"></i>
                Curated for Serious Collectors
            </h2>
        </div>
        <div class="row g-4">
            {% for listing in curated_listings %}
            <div class="col-6 col-md-4 col-lg-3">
                {% include 'components/listing_card.html' with listing=listing %}
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Why Heroes & More -->
<section class="section" style="position: relative; overflow: hidden;">
    <img src="{% static 'images/logo-transparent.png' %}" alt="" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; opacity: 0.04; pointer-events: none;">
    <div class="container position-relative">
        <div class="text-center mb-5">
            <h2 class="mb-3">Why Heroes &amp; More</h2>
        </div>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-percent"></i>
                    </div>
                    <h5 class="feature-title">Lower Fees. Higher Returns.</h5>
                    <p class="feature-desc">Starting at 5.95% commission &mdash; a fraction of what the big platforms charge. More of your money stays where it belongs: with you.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-heart"></i>
                    </div>
                    <h5 class="feature-title">Collector-First Marketplace</h5>
                    <p class="feature-desc">Built by collectors, for collectors. Price tracking, collection management, and a community that speaks your language.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="bi bi-award"></i>
                    </div>
                    <h5 class="feature-title">Built for Serious Buyers &amp; Sellers</h5>
                    <p class="feature-desc">Trusted Seller badges, buyer protection, graded item support, and curated platform auctions for the best inventory.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- WHERE LEGENDS LIVE Final CTA -->
<section class="section" style="background: var(--gradient-hero); color: #fff; padding: 5rem 0; position: relative;">
    <img src="{% static 'images/logo-transparent.png' %}" alt="" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; opacity: 0.06; pointer-events: none;">
    <div class="container text-center position-relative">
        <h2 style="font-size: 3rem; font-weight: 800; color: #fff; letter-spacing: -0.02em;">WHERE LEGENDS LIVE</h2>
        <p style="color: rgba(255,255,255,0.7); font-size: 1.15rem; max-width: 500px; margin: 1rem auto 2rem;">
            The premium destination for serious collectors. Start bidding or consign your collection today.
        </p>
        <div class="d-flex flex-wrap justify-content-center gap-3">
            <a href="{% url 'marketplace:listing_list' %}?type=auction" class="btn btn-light btn-lg">Start Bidding</a>
            <a href="{% url 'sell' %}" class="btn btn-outline-light btn-lg">Consign With Us</a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Countdown ticker for all [data-countdown] elements
(function() {
    var countdowns = document.querySelectorAll('[data-countdown]');
    if (!countdowns.length) return;

    function updateCountdowns() {
        var now = new Date().getTime();
        countdowns.forEach(function(el) {
            var end = new Date(el.getAttribute('data-countdown')).getTime();
            var diff = end - now;
            if (diff <= 0) {
                el.textContent = 'Ended';
                el.closest('.time-remaining')?.classList.add('text-muted');
                return;
            }
            var d = Math.floor(diff / 86400000);
            var h = Math.floor((diff % 86400000) / 3600000);
            var m = Math.floor((diff % 3600000) / 60000);
            var s = Math.floor((diff % 60000) / 1000);
            if (d > 0) {
                el.textContent = d + 'd ' + h + 'h';
            } else if (h > 0) {
                el.textContent = h + 'h ' + m + 'm';
            } else if (m > 0) {
                el.textContent = m + 'm ' + s + 's';
            } else {
                el.textContent = s + 's';
            }
            // Urgency classes
            var parent = el.closest('.time-remaining');
            if (parent) {
                if (diff < 10000) {
                    parent.classList.add('urgency-critical');
                    parent.classList.remove('urgency-warning');
                } else if (diff < 60000) {
                    parent.classList.add('urgency-warning');
                    parent.classList.remove('urgency-critical');
                }
            }
        });
    }

    updateCountdowns();
    setInterval(updateCountdowns, 1000);
})();
</script>
{% endblock %}
