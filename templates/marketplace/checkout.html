{% extends 'base.html' %}
{% load humanize %}

{% block title %}Checkout - HeroesAndMore{% endblock %}

{% block extra_css %}
<style>
    #card-element {
        padding: 12px;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        background: white;
    }
    #card-element.StripeElement--focus {
        border-color: var(--gray-900);
    }
    #card-element.StripeElement--invalid {
        border-color: var(--accent-danger);
    }
    #card-errors {
        color: var(--accent-danger);
        margin-top: 8px;
        font-size: 0.875rem;
    }
    .saved-card {
        cursor: pointer;
        transition: border-color 0.2s, background-color 0.2s;
        border: 1px solid var(--gray-200);
    }
    .saved-card:hover {
        border-color: var(--gray-400);
        background-color: var(--gray-50);
    }
    .saved-card.selected {
        border-color: var(--gray-900);
        background-color: var(--gray-50);
    }
    .card-brand-icon {
        width: 32px;
        height: 20px;
        object-fit: contain;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="section-alt border-bottom" style="padding: 1.5rem 0;">
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb mb-0" style="font-size: 0.875rem;">
                <li class="breadcrumb-item"><a href="{% url 'marketplace:listing_list' %}" class="text-muted">Listings</a></li>
                <li class="breadcrumb-item"><a href="{{ listing.get_absolute_url }}" class="text-muted">{{ listing.title|truncatechars:30 }}</a></li>
                <li class="breadcrumb-item active">Checkout</li>
            </ol>
        </nav>
        <h1 style="font-size: 1.75rem; margin-bottom: 0;">Checkout</h1>
    </div>
</div>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="row">
                <!-- Order Summary -->
                <div class="col-md-5 order-md-2 mb-4">
                    <div class="card">
                        <div class="card-header bg-transparent">
                            <h6 class="fw-bold mb-0">Order Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex mb-3">
                                {% if listing.image1 %}
                                <img src="{{ listing.image1.url }}" class="me-3" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                {% else %}
                                <div class="me-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; background: var(--gray-100); border-radius: 8px;">
                                    <i class="bi bi-image" style="font-size: 1.5rem; color: var(--gray-400);"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <h6 class="mb-1" style="color: var(--gray-900);">{{ listing.title }}</h6>
                                    <small class="text-muted">{{ listing.get_condition_display }}</small>
                                </div>
                            </div>

                            <hr style="border-color: var(--gray-200);">

                            {% if order.quantity > 1 %}
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Unit Price</span>
                                <span style="color: var(--gray-900);">${{ listing.price|intcomma }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Quantity</span>
                                <span style="color: var(--gray-900);">&times; {{ order.quantity }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Subtotal</span>
                                <span style="color: var(--gray-900);">${{ order.item_price|intcomma }}</span>
                            </div>
                            {% else %}
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Item Price</span>
                                <span style="color: var(--gray-900);">${{ order.item_price|intcomma }}</span>
                            </div>
                            {% endif %}
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Shipping</span>
                            <span style="color: var(--gray-900);">{% if order.shipping_price %}${{ order.shipping_price }}{% else %}<span style="color: var(--accent-success);">Free</span>{% endif %}</span>
                            </div>
                            <hr style="border-color: var(--gray-200);">
                            <div class="d-flex justify-content-between">
                                <strong style="color: var(--gray-900);">Total</strong>
                                <strong style="font-size: 1.25rem; color: var(--gray-900);">${{ total|intcomma }}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-body">
                            <h6 class="fw-bold mb-2" style="color: var(--gray-700);">Seller</h6>
                            <a href="{% url 'accounts:profile' username=listing.seller.username %}" class="text-decoration-none d-flex align-items-center">
                                <div class="rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; background: var(--gray-200);">
                                    <i class="bi bi-person" style="color: var(--gray-600);"></i>
                                </div>
                                <span style="color: var(--gray-900);">{{ listing.seller.username }}</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Checkout Form -->
                <div class="col-md-7 order-md-1">
                    {% if is_guest %}
                    <!-- Guest Info -->
                    <div class="card mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="fw-bold mb-0">Your Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small fw-semibold text-uppercase" style="letter-spacing: 0.05em; color: var(--gray-500);">Email *</label>
                                <input type="email" id="guest-email" class="form-control" required placeholder="you@example.com">
                            </div>
                            <div class="mb-0">
                                <label class="form-label small fw-semibold text-uppercase" style="letter-spacing: 0.05em; color: var(--gray-500);">Name</label>
                                <input type="text" id="guest-name" class="form-control" placeholder="Full name">
                            </div>
                            <p class="text-muted small mt-2 mb-0">
                                Already have an account? <a href="{% url 'account_login' %}?next={{ request.path }}">Sign in</a>
                            </p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Shipping Address -->
                    <div class="card mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="fw-bold mb-0">Shipping Address</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small fw-semibold text-uppercase" style="letter-spacing: 0.05em; color: var(--gray-500);">Full Name</label>
                                <input type="text" id="shipping-name" class="form-control" value="{% if not is_guest %}{{ user.get_full_name }}{% endif %}" required>
                            </div>

                            <div class="mb-0">
                                <label class="form-label small fw-semibold text-uppercase" style="letter-spacing: 0.05em; color: var(--gray-500);">Address</label>
                                <textarea id="shipping-address" class="form-control" rows="3" required placeholder="Street Address&#10;City, State ZIP&#10;Country">{{ order.shipping_address }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="card">
                        <div class="card-header bg-transparent">
                            <h6 class="fw-bold mb-0">Payment Method</h6>
                        </div>
                        <div class="card-body">
                            {% if not is_guest and payment_methods %}
                            <!-- Saved Payment Methods -->
                            <div class="mb-4">
                                <label class="form-label small fw-semibold text-uppercase" style="letter-spacing: 0.05em; color: var(--gray-500);">Saved Cards</label>
                                {% for pm in payment_methods %}
                                <div class="card saved-card mb-2 {% if pm.id == user.profile.default_payment_method_id %}selected{% endif %}"
                                     data-payment-method-id="{{ pm.id }}">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-credit-card me-2" style="color: var(--gray-600);"></i>
                                                <span class="text-capitalize">{{ pm.card.brand }}</span>
                                                <span class="mx-1 text-muted">****</span>
                                                <span>{{ pm.card.last4 }}</span>
                                                <small class="text-muted ms-3">{{ pm.card.exp_month }}/{{ pm.card.exp_year }}</small>
                                            </div>
                                            <input type="radio" name="selected_card" value="{{ pm.id }}"
                                                   class="form-check-input"
                                                   {% if pm.id == user.profile.default_payment_method_id %}checked{% endif %}>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                <button type="button" class="btn btn-link ps-0" id="use-new-card">
                                    <i class="bi bi-plus"></i> Use a different card
                                </button>
                            </div>
                            {% endif %}

                            <!-- New Card Form -->
                            <div id="new-card-form" {% if not is_guest and payment_methods %}style="display: none;"{% endif %}>
                                <label class="form-label small fw-semibold text-uppercase" style="letter-spacing: 0.05em; color: var(--gray-500);">Card Details</label>
                                <div id="card-element"></div>
                                <div id="card-errors" role="alert"></div>

                                {% if not is_guest %}
                                <div class="form-check mt-3">
                                    <input type="checkbox" class="form-check-input" id="save-card" checked>
                                    <label class="form-check-label text-muted" for="save-card">Save card for future purchases</label>
                                </div>
                                {% endif %}
                            </div>

                            <hr class="my-4" style="border-color: var(--gray-200);">

                            <!-- Pay Button -->
                            <button type="button" id="pay-button" class="btn btn-dark btn-lg w-100">
                                <span id="button-text">Pay ${{ total|intcomma }}</span>
                                <span id="spinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                            </button>

                            <p class="text-center mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="bi bi-lock me-1"></i> Secure checkout powered by Stripe
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();
const cardElement = elements.create('card', {
    style: {
        base: {
            fontSize: '16px',
            color: '#333',
            fontFamily: 'system-ui, -apple-system, sans-serif',
            '::placeholder': { color: '#aab7c4' }
        }
    }
});
cardElement.mount('#card-element');

// Handle card errors
cardElement.on('change', function(event) {
    const errorEl = document.getElementById('card-errors');
    errorEl.textContent = event.error ? event.error.message : '';
});

// Toggle new card form
document.getElementById('use-new-card')?.addEventListener('click', function() {
    document.getElementById('new-card-form').style.display = 'block';
    document.querySelectorAll('input[name="selected_card"]').forEach(r => r.checked = false);
    document.querySelectorAll('.saved-card').forEach(c => c.classList.remove('selected'));
});

// Select saved card
document.querySelectorAll('.saved-card').forEach(card => {
    card.addEventListener('click', function() {
        document.querySelectorAll('.saved-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        this.querySelector('input[type="radio"]').checked = true;
        document.getElementById('new-card-form').style.display = 'none';
    });
});

// Process payment
document.getElementById('pay-button').addEventListener('click', async function() {
    const button = this;
    const spinner = document.getElementById('spinner');
    const buttonText = document.getElementById('button-text');

    // Validate shipping address
    const shippingName = document.getElementById('shipping-name').value.trim();
    const shippingAddress = document.getElementById('shipping-address').value.trim();

    if (!shippingName || !shippingAddress) {
        document.getElementById('card-errors').textContent = 'Please enter your shipping address.';
        return;
    }

    // Guest checkout validation
    const isGuest = {{ is_guest|yesno:"true,false" }};
    let guestEmail = '';
    let guestName = '';
    if (isGuest) {
        guestEmail = document.getElementById('guest-email')?.value.trim() || '';
        guestName = document.getElementById('guest-name')?.value.trim() || '';
        if (!guestEmail) {
            document.getElementById('card-errors').textContent = 'Please enter your email address.';
            return;
        }
    }

    button.disabled = true;
    spinner.classList.remove('d-none');
    buttonText.textContent = 'Processing...';

    try {
        const selectedCard = document.querySelector('input[name="selected_card"]:checked');
        let paymentMethodId;
        let saveCard = false;

        if (selectedCard) {
            paymentMethodId = selectedCard.value;
        } else {
            saveCard = document.getElementById('save-card')?.checked;
            // Create new payment method
            const { paymentMethod, error } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: {
                    name: shippingName,
                }
            });

            if (error) {
                throw new Error(error.message);
            }
            paymentMethodId = paymentMethod.id;
        }

        const bodyParams = {
            payment_method_id: paymentMethodId,
            save_card: saveCard,
            shipping_address: shippingAddress
        };
        if (isGuest) {
            bodyParams.guest_email = guestEmail;
            bodyParams.guest_name = guestName;
        }

        const response = await fetch('{% url "marketplace:process_payment" pk=order.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams(bodyParams)
        });

        const data = await response.json();

        if (data.success) {
            window.location.href = data.redirect;
        } else if (data.requires_action) {
            const { error: actionError, paymentIntent } = await stripe.confirmCardPayment(data.client_secret);
            if (actionError) {
                throw new Error(actionError.message);
            }
            if (paymentIntent && paymentIntent.status === 'succeeded') {
                window.location.href = '{% url "marketplace:checkout_complete" pk=order.pk %}';
            }
        } else {
            throw new Error(data.error || 'Payment failed');
        }

    } catch (error) {
        document.getElementById('card-errors').textContent = error.message;
        button.disabled = false;
        spinner.classList.add('d-none');
        buttonText.textContent = 'Pay ${{ total|intcomma }}';
    }
});
</script>
{% endblock %}
