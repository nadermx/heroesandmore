{% extends 'base.html' %}

{% block title %}Set Up Payments - HeroesAndMore{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="h2 fw-bold">Set Up Your Seller Account</h1>
                <p class="text-muted">Complete the form below to start receiving payments. Your information is securely processed by Stripe.</p>
            </div>

            <!-- Progress indicator -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-dark text-white d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="bi bi-shield-check"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">Secure & Private</h6>
                            <p class="text-muted small mb-0">Your financial information is encrypted and securely stored by Stripe. We never see your bank details.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stripe Embedded Onboarding Container -->
            <div class="card">
                <div class="card-body p-4">
                    <div id="onboarding-container">
                        <div class="text-center py-5">
                            <div class="spinner-border text-dark" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-3">Loading payment setup...</p>
                        </div>
                    </div>

                    <!-- Error state (hidden by default) -->
                    <div id="onboarding-error" class="text-center py-5" style="display: none;">
                        <i class="bi bi-exclamation-triangle text-danger display-4"></i>
                        <h5 class="mt-3">Unable to Load Payment Setup</h5>
                        <p class="text-muted" id="error-message">Please try again or contact support.</p>
                        <button onclick="location.reload()" class="btn btn-dark">
                            <i class="bi bi-arrow-clockwise me-2"></i>Try Again
                        </button>
                    </div>
                </div>
            </div>

            <!-- Help section -->
            <div class="mt-4">
                <div class="card bg-light border-0">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3"><i class="bi bi-question-circle me-2"></i>Need Help?</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <p class="small mb-1"><strong>What do I need?</strong></p>
                                <ul class="small text-muted mb-0">
                                    <li>Bank account or debit card</li>
                                    <li>Tax ID for your country</li>
                                    <li>Valid ID (if requested)</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <p class="small mb-1"><strong>When will I get paid?</strong></p>
                                <p class="small text-muted mb-0">Payouts are sent automatically 2-3 business days after a sale completes.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stripe Connect.js -->
<script src="https://connect-js.stripe.com/v1.0/connect.js" async></script>

<script>
    const container = document.getElementById('onboarding-container');
    const errorDiv = document.getElementById('onboarding-error');
    const errorMessage = document.getElementById('error-message');

    const showError = (message) => {
        container.style.display = 'none';
        errorDiv.style.display = 'block';
        if (message) {
            errorMessage.textContent = message;
        }
    };

    const fetchClientSecret = async () => {
        const response = await fetch('{% url "marketplace:seller_setup_session" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to initialize payment setup');
        }

        const { client_secret } = await response.json();
        return client_secret;
    };

    // Use Stripe's onLoad callback pattern (recommended for script tag approach)
    window.StripeConnect = window.StripeConnect || {};
    StripeConnect.onLoad = () => {
        try {
            const stripeConnectInstance = StripeConnect.init({
                publishableKey: "{{ stripe_public_key }}",
                fetchClientSecret: fetchClientSecret,
                appearance: {
                    overlays: 'dialog',
                    variables: {
                        colorPrimary: '#171717',
                        colorBackground: '#ffffff',
                        colorText: '#171717',
                        colorDanger: '#DC2626',
                        fontFamily: 'Inter, system-ui, sans-serif',
                        fontSizeBase: '16px',
                        spacingUnit: '4px',
                        borderRadius: '8px',
                    },
                },
            });

            const onboarding = stripeConnectInstance.create('account-onboarding');

            onboarding.setOnExit(() => {
                window.location.href = '{% url "marketplace:seller_setup_return" %}';
            });

            container.innerHTML = '';
            container.appendChild(onboarding);
        } catch (error) {
            console.error('Stripe Connect error:', error);
            showError(error.message);
        }
    };
</script>
{% endblock %}
