{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ listing.title }} - HeroesAndMore{% endblock %}

{% block extra_css %}
<style>
    .product-image-main {
        aspect-ratio: 1;
        background: var(--gray-100);
        border-radius: 0.75rem;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .product-image-main img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .thumbnail-list {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .thumbnail-item {
        width: 72px;
        height: 72px;
        border-radius: 0.5rem;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.15s;
    }

    .thumbnail-item:hover,
    .thumbnail-item.active {
        border-color: var(--gray-900);
    }

    .thumbnail-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .price-display {
        font-size: 2rem;
        font-weight: 800;
        color: var(--gray-900);
        letter-spacing: -0.02em;
    }

    .price-display.auction {
        color: var(--accent-danger);
    }

    .detail-table {
        width: 100%;
    }

    .detail-table tr {
        border-bottom: 1px solid var(--gray-100);
    }

    .detail-table tr:last-child {
        border-bottom: none;
    }

    .detail-table th {
        padding: 0.75rem 0;
        font-weight: 500;
        color: var(--gray-500);
        font-size: 0.875rem;
        width: 40%;
    }

    .detail-table td {
        padding: 0.75rem 0;
        font-weight: 500;
        color: var(--gray-900);
        font-size: 0.875rem;
    }

    .seller-card {
        background: var(--gray-50);
        border-radius: 0.75rem;
        padding: 1.25rem;
    }

    .action-button {
        padding: 1rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 0.5rem;
    }

    .countdown-timer {
        background: #FEF2F2;
        color: var(--accent-danger);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bid-history {
        max-height: 200px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="section-alt border-bottom" style="padding: 1rem 0;">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0" style="font-size: 0.875rem;">
                <li class="breadcrumb-item"><a href="{% url 'marketplace:listing_list' %}" class="text-muted">Marketplace</a></li>
                {% if listing.category %}
                <li class="breadcrumb-item"><a href="{{ listing.category.get_absolute_url }}" class="text-muted">{{ listing.category.name }}</a></li>
                {% endif %}
                <li class="breadcrumb-item active text-truncate" style="max-width: 200px;">{{ listing.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="container py-4">
    <div class="row">
        <!-- Images Column -->
        <div class="col-lg-6 mb-4">
            <div class="position-sticky" style="top: 100px;">
                <!-- Main Image -->
                <div class="product-image-main" id="mainImageContainer">
                    {% if listing.image1 %}
                    <img src="{{ listing.image1.url }}" alt="{{ listing.title }}" id="mainImage">
                    {% else %}
                    <i class="bi bi-image" style="font-size: 5rem; color: var(--gray-300);"></i>
                    {% endif %}
                </div>

                <!-- Thumbnails -->
                {% if listing.get_images|length > 1 %}
                <div class="thumbnail-list">
                    {% for image in listing.get_images %}
                    <div class="thumbnail-item {% if forloop.first %}active{% endif %}" onclick="switchImage(this, '{{ image.url }}')">
                        <img src="{{ image.url }}" alt="Thumbnail {{ forloop.counter }}">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Share buttons -->
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-outline-dark btn-sm flex-fill" onclick="navigator.share({title: '{{ listing.title }}', url: window.location.href})">
                        <i class="bi bi-share me-1"></i> Share
                    </button>
                    <button class="btn btn-outline-dark btn-sm">
                        <i class="bi bi-flag me-1"></i> Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Details Column -->
        <div class="col-lg-6">
            <!-- Title & Badges -->
            <div class="mb-3">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% if listing.listing_type == 'auction' %}
                    <span class="badge badge-auction">Auction</span>
                    {% endif %}
                    {% if listing.grading_service %}
                    <span class="badge badge-grade">{{ listing.grading_service|upper }} {{ listing.grade }}</span>
                    {% endif %}
                    {% if listing.condition %}
                    <span class="badge badge-condition">{{ listing.get_condition_display }}</span>
                    {% endif %}
                </div>
                <h1 style="font-size: 1.75rem; line-height: 1.3; margin-bottom: 0;">{{ listing.title }}</h1>
            </div>

            <!-- Price Section -->
            <div class="card mb-4">
                <div class="card-body p-4">
                    {% if listing.listing_type == 'auction' %}
                    <div class="row align-items-center">
                        <div class="col">
                            <span class="text-muted small text-uppercase" style="letter-spacing: 0.05em;">Current Bid</span>
                            <div class="price-display auction">${{ listing.get_current_price|intcomma }}</div>
                            {% if listing.bids.count %}
                            <span class="text-muted small">{{ listing.bids.count }} bid{{ listing.bids.count|pluralize }}</span>
                            {% else %}
                            <span class="text-muted small">No bids yet</span>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            {% if listing.time_remaining and not listing.is_auction_ended %}
                            <div class="countdown-timer">
                                <i class="bi bi-clock"></i>
                                <span id="countdown">
                                    {% with remaining=listing.time_remaining %}
                                        {% if remaining.days > 0 %}{{ remaining.days }}d {% endif %}
                                        {% if remaining.hours > 0 %}{{ remaining.hours }}h {% endif %}
                                        {{ remaining.minutes }}m
                                    {% endwith %}
                                </span>
                            </div>
                            {% else %}
                            <span class="badge bg-secondary">Ended</span>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <span class="text-muted small text-uppercase" style="letter-spacing: 0.05em;">Price</span>
                    <div class="price-display">${{ listing.price|intcomma }}</div>
                    {% endif %}

                    <div class="text-muted small mt-2">
                        {% if listing.shipping_price and listing.shipping_price > 0 %}
                        <i class="bi bi-truck me-1"></i> + ${{ listing.shipping_price|floatformat:2 }} shipping
                        {% else %}
                        <i class="bi bi-truck me-1"></i> Free shipping
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            {% if user.is_authenticated and user != listing.seller %}
            <div class="d-grid gap-2 mb-4">
                {% if listing.listing_type == 'auction' and not listing.is_auction_ended %}
                <form method="post" action="{% url 'marketplace:place_bid' pk=listing.pk %}">
                    {% csrf_token %}
                    <div class="input-group input-group-lg mb-2">
                        <span class="input-group-text">$</span>
                        <input type="number" name="amount" class="form-control" step="0.01"
                               min="{{ listing.get_current_price|add:1 }}"
                               placeholder="Enter bid amount" required>
                        <button type="submit" class="btn btn-dark action-button">
                            Place Bid
                        </button>
                    </div>
                    <small class="text-muted">Minimum bid: ${{ listing.get_current_price|add:1|intcomma }}</small>
                </form>
                {% elif listing.listing_type == 'fixed' and listing.status == 'active' %}
                <a href="{% url 'marketplace:checkout' pk=listing.pk %}" class="btn btn-dark action-button">
                    <i class="bi bi-bag me-2"></i> Buy Now â€” ${{ listing.price|intcomma }}
                </a>
                {% if listing.allow_offers %}
                <button class="btn btn-outline-dark action-button" data-bs-toggle="modal" data-bs-target="#offerModal">
                    <i class="bi bi-tag me-2"></i> Make an Offer
                </button>
                {% endif %}
                {% endif %}

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-dark flex-fill"
                            hx-post="{% url 'marketplace:save_listing' pk=listing.pk %}"
                            hx-swap="innerHTML">
                        {% if is_saved %}
                        <i class="bi bi-heart-fill" style="color: var(--accent-danger);"></i> Saved
                        {% else %}
                        <i class="bi bi-heart"></i> Save
                        {% endif %}
                    </button>
                    <a href="{% url 'social:compose_to' username=listing.seller.username %}" class="btn btn-outline-dark flex-fill">
                        <i class="bi bi-chat me-1"></i> Message Seller
                    </a>
                </div>
            </div>
            {% elif user == listing.seller %}
            <div class="d-grid gap-2 mb-4">
                <a href="{% url 'marketplace:listing_edit' pk=listing.pk %}" class="btn btn-outline-dark action-button">
                    <i class="bi bi-pencil me-2"></i> Edit Listing
                </a>
                {% if listing.status == 'draft' %}
                <a href="{% url 'marketplace:listing_publish' pk=listing.pk %}" class="btn btn-dark action-button">
                    <i class="bi bi-check-circle me-2"></i> Publish Listing
                </a>
                {% endif %}
            </div>
            {% else %}
            <div class="card mb-4" style="background: var(--gray-50);">
                <div class="card-body text-center py-4">
                    <p class="mb-3">Sign in to purchase this item</p>
                    <div class="d-flex gap-2 justify-content-center">
                        <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-dark">Sign In</a>
                        <a href="{% url 'account_signup' %}" class="btn btn-outline-dark">Create Account</a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Seller Info -->
            <div class="seller-card mb-4">
                <div class="d-flex align-items-center">
                    {% if listing.seller.profile.avatar %}
                    <img src="{{ listing.seller.profile.avatar.url }}" class="rounded-circle me-3" width="56" height="56" style="object-fit: cover;">
                    {% else %}
                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: var(--gray-200);">
                        <span style="font-size: 1.25rem; font-weight: 600; color: var(--gray-600);">{{ listing.seller.username|slice:":1"|upper }}</span>
                    </div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <a href="{% url 'accounts:profile' username=listing.seller.username %}" class="fw-bold text-decoration-none" style="font-size: 1.1rem;">
                            {{ listing.seller.username }}
                        </a>
                        {% if listing.seller.profile.is_seller_verified %}
                        <i class="bi bi-patch-check-fill ms-1" style="color: var(--accent-success);" title="Verified Seller"></i>
                        {% endif %}
                        <div class="d-flex align-items-center gap-3 mt-1">
                            {% if listing.seller.profile.rating %}
                            <span class="small">
                                <i class="bi bi-star-fill" style="color: #FBBF24;"></i>
                                {{ listing.seller.profile.rating|floatformat:1 }}
                                <span class="text-muted">({{ listing.seller.profile.rating_count }} reviews)</span>
                            </span>
                            {% endif %}
                            <span class="small text-muted">
                                {{ listing.seller.listings.count }} listings
                            </span>
                        </div>
                    </div>
                    <a href="{% url 'accounts:profile' username=listing.seller.username %}" class="btn btn-outline-dark btn-sm">
                        View Profile
                    </a>
                </div>
            </div>

            <!-- Item Details -->
            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">Item Details</h6>
                    <table class="detail-table">
                        <tr>
                            <th>Condition</th>
                            <td>{{ listing.get_condition_display }}</td>
                        </tr>
                        {% if listing.grading_service %}
                        <tr>
                            <th>Grading Service</th>
                            <td>{{ listing.grading_service|upper }}</td>
                        </tr>
                        <tr>
                            <th>Grade</th>
                            <td>{{ listing.grade }}</td>
                        </tr>
                        {% if listing.cert_number %}
                        <tr>
                            <th>Cert Number</th>
                            <td>{{ listing.cert_number }}</td>
                        </tr>
                        {% endif %}
                        {% endif %}
                        <tr>
                            <th>Category</th>
                            <td><a href="{{ listing.category.get_absolute_url }}" class="text-decoration-none">{{ listing.category.name }}</a></td>
                        </tr>
                        {% if listing.ships_from %}
                        <tr>
                            <th>Ships From</th>
                            <td>{{ listing.ships_from }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Listed</th>
                            <td>{{ listing.created|date:"M d, Y" }}</td>
                        </tr>
                        <tr>
                            <th>Views</th>
                            <td>{{ listing.views|intcomma }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Buyer Protection -->
            <div class="card" style="background: var(--gray-50); border: none;">
                <div class="card-body">
                    <div class="d-flex align-items-start gap-3">
                        <div class="flex-shrink-0">
                            <i class="bi bi-shield-check fs-4" style="color: var(--accent-success);"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">Buyer Protection</h6>
                            <p class="small text-muted mb-0">All purchases are protected. Get your item as described or your money back.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Description & Comments -->
    <div class="row mt-5">
        <div class="col-lg-8">
            <!-- Description -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Description</h5>
                    <div style="white-space: pre-wrap; line-height: 1.7; color: var(--gray-700);">{{ listing.description }}</div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Questions & Comments</h5>
                        <span class="badge bg-dark">{{ listing.comments.count }}</span>
                    </div>

                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'social:add_comment' listing_pk=listing.pk %}" class="mb-4">
                        {% csrf_token %}
                        <div class="d-flex gap-3">
                            {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                            {% else %}
                            <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background: var(--gray-200);">
                                <span style="font-weight: 600; color: var(--gray-600);">{{ user.username|slice:":1"|upper }}</span>
                            </div>
                            {% endif %}
                            <div class="flex-grow-1">
                                <textarea name="content" class="form-control mb-2" rows="2" placeholder="Ask a question or leave a comment..." required></textarea>
                                <button type="submit" class="btn btn-dark btn-sm">Post Comment</button>
                            </div>
                        </div>
                    </form>
                    {% endif %}

                    <div class="comments-list">
                        {% for comment in listing.comments.all %}
                        <div class="d-flex gap-3 {% if not forloop.last %}mb-4 pb-4 border-bottom{% endif %}">
                            {% if comment.author.profile.avatar %}
                            <img src="{{ comment.author.profile.avatar.url }}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                            {% else %}
                            <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background: var(--gray-200);">
                                <span style="font-weight: 600; color: var(--gray-600);">{{ comment.author.username|slice:":1"|upper }}</span>
                            </div>
                            {% endif %}
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <a href="{% url 'accounts:profile' username=comment.author.username %}" class="fw-semibold text-decoration-none">
                                            {{ comment.author.username }}
                                        </a>
                                        {% if comment.author == listing.seller %}
                                        <span class="badge bg-dark ms-1" style="font-size: 0.65rem;">Seller</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ comment.created|timesince }} ago</small>
                                </div>
                                <p class="mb-0 mt-1" style="color: var(--gray-700);">{{ comment.content }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="bi bi-chat-dots display-4 text-muted"></i>
                            <p class="text-muted mt-2 mb-0">No comments yet. Be the first to ask a question!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            {% if seller_listings %}
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">More from {{ listing.seller.username }}</h6>
                        <a href="{% url 'accounts:profile' username=listing.seller.username %}" class="small">View all</a>
                    </div>
                    <div class="row g-2">
                        {% for item in seller_listings|slice:":4" %}
                        <div class="col-6">
                            {% include 'components/listing_card.html' with listing=item %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if related %}
            <div class="card">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">Similar Items</h6>
                    <div class="row g-2">
                        {% for item in related|slice:":4" %}
                        <div class="col-6">
                            {% include 'components/listing_card.html' with listing=item %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Offer Modal -->
{% if listing.allow_offers %}
<div class="modal fade" id="offerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" action="{% url 'marketplace:make_offer' pk=listing.pk %}">
                {% csrf_token %}
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Make an Offer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Current listing price: <strong class="text-dark">${{ listing.price|intcomma }}</strong></p>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Your Offer</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">$</span>
                            <input type="number" name="amount" class="form-control" step="0.01" min="1" placeholder="0.00" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Message to Seller (optional)</label>
                        <textarea name="message" class="form-control" rows="3" placeholder="Add a note with your offer..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark">Submit Offer</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function switchImage(thumb, imageUrl) {
    document.getElementById('mainImage').src = imageUrl;
    document.querySelectorAll('.thumbnail-item').forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
}
</script>
{% endblock %}
