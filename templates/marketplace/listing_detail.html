{% extends 'base.html' %}
{% load humanize %}
{% load seo_tags %}

{% block title %}{{ listing.title }} - HeroesAndMore{% endblock %}
{% block meta_description %}{{ listing.title }}{% if listing.is_graded %} — {{ listing.grading_service|upper }} {{ listing.grade }}{% endif %}{% if listing.condition %} ({{ listing.get_condition_display }}){% endif %} — ${{ listing.price }} on HeroesAndMore.{% endblock %}
{% block og_title %}{{ listing.title }} - HeroesAndMore{% endblock %}
{% block og_description %}{{ listing.title }}{% if listing.is_graded %} — {{ listing.grading_service|upper }} {{ listing.grade }}{% endif %} — ${{ listing.price }} on HeroesAndMore.{% endblock %}
{% block og_type %}product{% endblock %}
{% block og_image %}{% if listing.image1 %}{% absolute_media listing.image1 %}{% else %}{{ default_og_image }}{% endif %}{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Product",
  "name": "{{ listing.title|json_ld_escape }}",
  "description": "{{ listing.description|truncatewords:50|json_ld_escape }}",
  {% if listing.image1 %}"image": "{% absolute_media listing.image1 %}",{% endif %}
  "offers": {
    "@type": "Offer",
    "url": "{{ request.build_absolute_uri }}",
    "priceCurrency": "USD",
    "price": "{{ listing.price }}",
    "availability": "https://schema.org/{% if listing.status == 'active' %}InStock{% else %}SoldOut{% endif %}",
    "itemCondition": "https://schema.org/{% if listing.condition == 'new' %}NewCondition{% else %}UsedCondition{% endif %}"{% if listing.seller %},
    "seller": {
      "@type": "Person",
      "name": "{{ listing.seller.username|json_ld_escape }}"
    }{% endif %}
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {"@type": "ListItem", "position": 1, "name": "Home", "item": "{{ site_url }}"},
    {"@type": "ListItem", "position": 2, "name": "Marketplace", "item": "{{ site_url }}/marketplace/"},
    {"@type": "ListItem", "position": 3, "name": "{{ listing.title|json_ld_escape }}"}
  ]
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    .product-image-main {
        aspect-ratio: 1;
        background: var(--gray-100);
        border-radius: 0.75rem;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .product-image-main img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .thumbnail-list {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .thumbnail-item {
        width: 72px;
        height: 72px;
        border-radius: 0.5rem;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.15s;
    }

    .thumbnail-item:hover,
    .thumbnail-item.active {
        border-color: var(--gray-900);
    }

    .thumbnail-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .price-display {
        font-size: 2rem;
        font-weight: 800;
        color: var(--gray-900);
        letter-spacing: -0.02em;
    }

    .price-display.auction {
        color: var(--accent-danger);
    }

    .detail-table {
        width: 100%;
    }

    .detail-table tr {
        border-bottom: 1px solid var(--gray-100);
    }

    .detail-table tr:last-child {
        border-bottom: none;
    }

    .detail-table th {
        padding: 0.75rem 0;
        font-weight: 500;
        color: var(--gray-500);
        font-size: 0.875rem;
        width: 40%;
    }

    .detail-table td {
        padding: 0.75rem 0;
        font-weight: 500;
        color: var(--gray-900);
        font-size: 0.875rem;
    }

    .seller-card {
        background: var(--gray-50);
        border-radius: 0.75rem;
        padding: 1.25rem;
    }

    .action-button {
        padding: 1rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 0.5rem;
    }

    .product-image-main {
        cursor: zoom-in;
    }

    .countdown-timer {
        background: #FEF2F2;
        color: var(--accent-danger);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bid-history {
        max-height: 200px;
        overflow-y: auto;
    }

    /* Sticky Bid Bar */
    .sticky-bid-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 2px solid var(--gray-200);
        padding: 0.75rem 0;
        z-index: 1040;
        box-shadow: 0 -4px 12px rgba(22,36,71,0.1);
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }

    .sticky-bid-bar.visible {
        transform: translateY(0);
    }

    /* Social proof pulse */
    .social-proof-pulse {
        animation: social-pulse 1.5s ease-in-out infinite;
    }

    @keyframes social-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Countdown urgency */
    .countdown-timer.urgency-warning {
        background: #FEE2E2;
        color: #DC2626;
    }

    .countdown-timer.urgency-critical {
        background: #DC2626;
        color: #fff;
        animation: countdown-pulse 0.5s ease-in-out infinite;
    }

    @keyframes countdown-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.03); }
    }

    /* Quick bid buttons */
    .quick-bid-btn {
        font-weight: 600;
        transition: all 0.15s;
    }

    .quick-bid-btn:hover {
        background-color: var(--brand-navy);
        color: #fff;
        transform: translateY(-1px);
    }

    /* Image Zoom Lightbox */
    .zoom-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        display: none;
        cursor: grab;
        touch-action: none;
    }

    .zoom-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .zoom-overlay img {
        max-width: 95vw;
        max-height: 95vh;
        object-fit: contain;
        transform-origin: center center;
        transition: transform 0.1s ease;
        user-select: none;
        -webkit-user-drag: none;
    }

    .zoom-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255,255,255,0.15);
        border: none;
        color: #fff;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .zoom-close:hover {
        background: rgba(255,255,255,0.3);
    }

    .zoom-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.15);
        border: none;
        color: #fff;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        font-size: 1.25rem;
        cursor: pointer;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .zoom-nav:hover {
        background: rgba(255,255,255,0.3);
    }

    .zoom-prev { left: 1rem; }
    .zoom-next { right: 1rem; }

    .zoom-hint {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255,255,255,0.5);
        font-size: 0.8rem;
        z-index: 10000;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="section-alt border-bottom" style="padding: 1rem 0;">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0" style="font-size: 0.875rem;">
                <li class="breadcrumb-item"><a href="{% url 'marketplace:listing_list' %}" class="text-muted">Marketplace</a></li>
                {% if listing.category %}
                <li class="breadcrumb-item"><a href="{{ listing.category.get_absolute_url }}" class="text-muted">{{ listing.category.name }}</a></li>
                {% endif %}
                <li class="breadcrumb-item active text-truncate" style="max-width: 200px;">{{ listing.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="container py-4">
    <div class="row">
        <!-- Images Column -->
        <div class="col-lg-6 mb-4">
            <div class="position-sticky" style="top: 100px;">
                <!-- Main Image -->
                <div class="product-image-main" id="mainImageContainer">
                    {% if listing.image1 %}
                    <img src="{{ listing.image1.url }}" alt="{{ listing.title }}" id="mainImage">
                    {% else %}
                    <i class="bi bi-image" style="font-size: 5rem; color: var(--gray-300);"></i>
                    {% endif %}
                </div>

                <!-- Thumbnails -->
                {% if listing.get_images|length > 1 %}
                <div class="thumbnail-list">
                    {% for image in listing.get_images %}
                    <div class="thumbnail-item {% if forloop.first %}active{% endif %}" onclick="switchImage(this, '{{ image.url }}')">
                        <img src="{{ image.url }}" alt="Thumbnail {{ forloop.counter }}">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Share buttons -->
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-outline-dark btn-sm flex-fill" onclick="navigator.share({title: '{{ listing.title }}', url: window.location.href})">
                        <i class="bi bi-share me-1"></i> Share
                    </button>
                    <button class="btn btn-outline-dark btn-sm">
                        <i class="bi bi-flag me-1"></i> Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Details Column -->
        <div class="col-lg-6">
            <!-- Title & Badges -->
            <div class="mb-3">
                <div class="d-flex flex-wrap gap-2 mb-2">
                    {% if listing.listing_type == 'auction' %}
                    <span class="badge badge-auction">Auction</span>
                    {% endif %}
                    {% if listing.grading_service %}
                    <span class="badge badge-grade">{{ listing.grading_service|upper }} {{ listing.grade }}</span>
                    {% endif %}
                    {% if listing.condition %}
                    <span class="badge badge-condition">{{ listing.get_condition_display }}</span>
                    {% endif %}
                    {% if listing.quantity > 1 and listing.listing_type == 'fixed' %}
                    <span class="badge bg-info text-white">{{ listing.quantity_available }} available</span>
                    {% endif %}
                </div>
                <h1 style="font-size: 1.75rem; line-height: 1.3; margin-bottom: 0;">{{ listing.title }}</h1>
            </div>

            <!-- Price Section -->
            <div class="card mb-4">
                <div class="card-body p-4">
                    {% if listing.listing_type == 'auction' %}
                    <div class="row align-items-center">
                        <div class="col">
                            <span class="text-muted small text-uppercase" style="letter-spacing: 0.05em;">Current Bid</span>
                            <div class="price-display auction">${{ listing.get_current_price|intcomma }}</div>
                            {% if listing.bids.count %}
                            <span class="text-muted small">{{ listing.bids.count }} bid{{ listing.bids.count|pluralize }}</span>
                            {% else %}
                            <span class="text-muted small">No bids yet</span>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            {% if listing.time_remaining and not listing.is_auction_ended %}
                            <div class="countdown-timer" id="countdownTimer" data-auction-end="{{ auction_end_iso }}">
                                <i class="bi bi-clock"></i>
                                <span id="countdown">
                                    {% with remaining=listing.time_remaining_parts %}
                                        {% if remaining %}
                                            {% if remaining.days > 0 %}{{ remaining.days }}d {% endif %}
                                            {% if remaining.hours > 0 %}{{ remaining.hours }}h {% endif %}
                                            {{ remaining.minutes }}m
                                        {% endif %}
                                    {% endwith %}
                                </span>
                            </div>
                            {% else %}
                            <span class="badge bg-secondary">Ended</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Social Proof -->
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        {% if watcher_count %}
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-eye"></i> {{ watcher_count }} watching
                        </span>
                        {% endif %}
                        {% if recent_bid_count %}
                        <span class="badge bg-light text-dark social-proof-pulse">
                            <i class="bi bi-lightning-fill" style="color: var(--brand-primary);"></i> {{ recent_bid_count }} bid{{ recent_bid_count|pluralize }} in last minute
                        </span>
                        {% endif %}
                        {% if bid_war_active %}
                        <span class="badge social-proof-pulse" style="background: linear-gradient(135deg, #FF6B6B, #E63946); color: #fff;">
                            <i class="bi bi-fire"></i> Bid war active
                        </span>
                        {% endif %}
                    </div>
                    {% else %}
                    <span class="text-muted small text-uppercase" style="letter-spacing: 0.05em;">Price</span>
                    <div class="price-display">${{ listing.price|intcomma }}</div>
                    {% if watcher_count %}
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-eye"></i> {{ watcher_count }} watching
                        </span>
                    </div>
                    {% endif %}
                    {% endif %}

                    <div class="text-muted small mt-2">
                        {% if listing.shipping_price and listing.shipping_price > 0 %}
                        <i class="bi bi-truck me-1"></i> + ${{ listing.shipping_price|floatformat:2 }} shipping
                        {% else %}
                        <i class="bi bi-truck me-1"></i> Free shipping
                        {% endif %}
                    </div>

                    <!-- Recent Sales Ticker -->
                    {% if recent_sales %}
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-graph-up-arrow text-success"></i>
                            <span class="small fw-semibold text-uppercase" style="letter-spacing: 0.05em;">Recent Sales</span>
                        </div>
                        {% if comps_range %}
                        <div class="mb-2" style="font-size: 0.95rem;">
                            <strong>Recent Comps:</strong>
                            <span style="color: var(--brand-navy);">${{ comps_range.low|intcomma }} &ndash; ${{ comps_range.high|intcomma }}</span>
                        </div>
                        {% endif %}
                        <div class="recent-sales-ticker">
                            {% for sale in recent_sales %}
                            <span class="badge bg-light text-dark me-1 mb-1" style="font-size: 0.8rem;">
                                {{ sale.get_source_display }} <strong>${{ sale.sale_price|intcomma }}</strong>
                            </span>
                            {% endfor %}
                        </div>
                        {% if listing.price_guide_item %}
                        <a href="{{ listing.price_guide_item.get_absolute_url }}" class="small text-muted">
                            View full price history <i class="bi bi-arrow-right"></i>
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Counter-Offer Response -->
            {% if pending_counter %}
            <div class="card mb-4" style="border: 2px solid #2563eb;">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <i class="bi bi-tag-fill" style="color: #2563eb;"></i>
                        <h6 class="fw-bold mb-0" style="color: #2563eb;">Counter Offer Received</h6>
                    </div>
                    <p class="text-muted mb-2">The seller has responded to your offer:</p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="text-muted">Your offer:</span>
                            <span class="text-decoration-line-through ms-1">${{ pending_counter.amount }}</span>
                        </div>
                        <div>
                            <span class="text-muted">Counter:</span>
                            <span class="fs-4 fw-bold ms-1" style="color: #2563eb;">${{ pending_counter.counter_amount }}</span>
                        </div>
                    </div>
                    <p class="small text-muted mb-3">
                        <i class="bi bi-clock me-1"></i>
                        Expires in {{ pending_counter.time_remaining }}
                    </p>
                    <form method="post" action="{% url 'marketplace:respond_counter_offer' pk=pending_counter.pk %}">
                        {% csrf_token %}
                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="accept" class="btn btn-dark">
                                <i class="bi bi-check-circle me-1"></i> Accept Counter Offer
                            </button>
                            <button type="submit" name="action" value="decline" class="btn btn-outline-secondary">
                                Decline
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            {% if user.is_authenticated and user != listing.seller %}
            <div class="d-grid gap-2 mb-4">
                {% if listing.listing_type == 'auction' and not listing.is_auction_ended %}
                <form method="post" action="{% url 'marketplace:place_bid' pk=listing.pk %}" id="bidForm">
                    {% csrf_token %}
                    <div class="input-group input-group-lg mb-2">
                        <span class="input-group-text">$</span>
                        <input type="number" name="amount" id="bidAmount" class="form-control" step="0.01"
                               min="{{ listing.get_current_price|add:1 }}"
                               placeholder="Enter max bid" required>
                        <button type="submit" class="btn btn-dark action-button">
                            Place Bid
                        </button>
                    </div>
                    <small class="text-muted d-block mb-1">Enter the max you're willing to pay. We'll bid just enough to keep you winning.</small>
                    <small class="text-muted">Minimum bid: ${{ listing.get_current_price|add:1|intcomma }}</small>
                    <!-- Quick Bid Buttons -->
                    <div class="d-flex gap-2 mt-2">
                        <button type="button" class="btn btn-outline-dark btn-sm quick-bid-btn" data-increment="10">+$10</button>
                        <button type="button" class="btn btn-outline-dark btn-sm quick-bid-btn" data-increment="25">+$25</button>
                        <button type="button" class="btn btn-outline-dark btn-sm quick-bid-btn" data-increment="50">+$50</button>
                    </div>
                </form>

                <!-- Active Auto-Bid Indicator -->
                {% if user_autobid %}
                <div class="alert alert-success d-flex align-items-center justify-content-between mt-3 mb-0 py-2 px-3" style="font-size: 0.85rem;">
                    <div>
                        <i class="bi bi-robot me-1"></i>
                        <strong>Auto-bidding active</strong> up to ${{ user_autobid.max_amount|intcomma }}
                    </div>
                    <form method="post" action="{% url 'marketplace:cancel_autobid' pk=listing.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-2">Cancel</button>
                    </form>
                </div>
                {% endif %}

                <!-- Bid History -->
                {% if bids %}
                <div class="card mt-3">
                    <div class="card-body p-3">
                        <h6 class="fw-bold mb-2" style="font-size: 0.85rem;">Bid History</h6>
                        <div class="bid-history">
                            <table class="table table-sm table-borderless mb-0" style="font-size: 0.8rem;">
                                <tbody>
                                    {% for bid in bids %}
                                    <tr{% if forloop.first %} style="color: var(--brand-primary); font-weight: 600;"{% endif %}>
                                        <td>
                                            {% if forloop.first %}<i class="bi bi-trophy-fill" style="color: var(--brand-gold);"></i> {% endif %}
                                            {{ bid.bidder.username }}
                                            {% if bid.is_auto_bid %}<span class="badge bg-secondary" style="font-size: 0.65rem; vertical-align: middle;">auto</span>{% endif %}
                                        </td>
                                        <td class="text-end fw-semibold">${{ bid.amount|intcomma }}</td>
                                        <td class="text-end text-muted">{{ bid.created|timesince }} ago</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% elif listing.listing_type == 'fixed' and listing.status == 'active' and listing.quantity_available > 0 %}
                {% if listing.quantity > 1 %}
                <div class="d-flex align-items-center gap-3 mb-2">
                    <label class="fw-semibold text-nowrap" for="buy-qty">Qty:</label>
                    <input type="number" id="buy-qty" class="form-control" style="max-width: 100px;"
                           value="1" min="1" max="{{ listing.quantity_available }}">
                    <span class="text-muted text-nowrap small">of {{ listing.quantity_available }} available</span>
                </div>
                {% endif %}
                <a href="{% url 'marketplace:checkout' pk=listing.pk %}" id="buy-now-btn" class="btn btn-dark action-button">
                    <i class="bi bi-bag me-2"></i> Buy Now — ${{ listing.price|intcomma }}
                </a>
                {% if listing.allow_offers %}
                <button class="btn btn-outline-dark action-button" data-bs-toggle="modal" data-bs-target="#offerModal">
                    <i class="bi bi-tag me-2"></i> Make an Offer
                </button>
                {% endif %}
                {% elif listing.listing_type == 'fixed' and listing.quantity_available == 0 %}
                <button class="btn btn-secondary action-button" disabled>
                    <i class="bi bi-bag-x me-2"></i> Sold Out
                </button>
                {% endif %}

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-dark flex-fill"
                            hx-post="{% url 'marketplace:save_listing' pk=listing.pk %}"
                            hx-swap="innerHTML">
                        {% if is_saved %}
                        <i class="bi bi-heart-fill" style="color: var(--accent-danger);"></i> Saved
                        {% else %}
                        <i class="bi bi-heart"></i> Save
                        {% endif %}
                    </button>
                    <a href="{% url 'social:compose_to' username=listing.seller.username %}" class="btn btn-outline-dark flex-fill">
                        <i class="bi bi-chat me-1"></i> Message Seller
                    </a>
                </div>
            </div>
            {% elif user == listing.seller %}
            <div class="d-grid gap-2 mb-4">
                <a href="{% url 'marketplace:listing_edit' pk=listing.pk %}" class="btn btn-outline-dark action-button">
                    <i class="bi bi-pencil me-2"></i> Edit Listing
                </a>
                {% if listing.status == 'draft' %}
                <a href="{% url 'marketplace:listing_publish' pk=listing.pk %}" class="btn btn-dark action-button">
                    <i class="bi bi-check-circle me-2"></i> Publish Listing
                </a>
                {% endif %}
            </div>
            {% else %}
            <div class="d-grid gap-2 mb-4">
                {% if listing.listing_type == 'auction' and not listing.is_auction_ended %}
                <a href="{% url 'account_signup' %}?next={{ request.path }}" class="btn btn-dark action-button">
                    <i class="bi bi-hammer me-2"></i> Sign In to Bid
                </a>
                {% elif listing.listing_type == 'fixed' and listing.status == 'active' and listing.quantity_available > 0 %}
                <a href="{% url 'marketplace:checkout' pk=listing.pk %}" class="btn btn-dark action-button">
                    <i class="bi bi-bag me-2"></i> Buy Now — ${{ listing.price|intcomma }}
                </a>
                {% if listing.allow_offers %}
                <a href="{% url 'account_signup' %}?next={{ request.path }}" class="btn btn-outline-dark action-button">
                    <i class="bi bi-tag me-2"></i> Make an Offer
                </a>
                {% endif %}
                {% elif listing.listing_type == 'fixed' and listing.quantity_available == 0 %}
                <button class="btn btn-secondary action-button" disabled>
                    <i class="bi bi-bag-x me-2"></i> Sold Out
                </button>
                {% endif %}
            </div>
            {% endif %}

            <!-- Seller Info -->
            <div class="seller-card mb-4">
                {% if listing.is_platform_listing %}
                <div class="d-flex align-items-center">
                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: linear-gradient(135deg, #162447 0%, #1a1a2e 100%);">
                        <i class="bi bi-shield-check text-warning" style="font-size: 1.5rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <span class="fw-bold" style="font-size: 1.1rem;">Sold by HeroesAndMore</span>
                        <span class="badge bg-warning text-dark ms-2" style="font-size: 0.7em;">Official</span>
                        <div class="mt-1">
                            <span class="small text-muted">Curated and shipped by the HeroesAndMore team</span>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="d-flex align-items-center">
                    {% if listing.seller.profile.avatar %}
                    <img src="{{ listing.seller.profile.avatar.url }}" class="rounded-circle me-3" width="56" height="56" style="object-fit: cover;">
                    {% else %}
                    <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 56px; height: 56px; background: var(--gray-200);">
                        <span style="font-size: 1.25rem; font-weight: 600; color: var(--gray-600);">{{ listing.seller.username|slice:":1"|upper }}</span>
                    </div>
                    {% endif %}
                    <div class="flex-grow-1">
                        <a href="{% url 'accounts:profile' username=listing.seller.username %}" class="fw-bold text-decoration-none" style="font-size: 1.1rem;">
                            {{ listing.seller.username }}
                        </a>
                        {% if listing.seller.profile.is_seller_verified %}
                        <i class="bi bi-patch-check-fill ms-1" style="color: var(--accent-success);" title="Verified Seller"></i>
                        {% endif %}
                        {% if listing.seller.profile.is_trusted_seller %}
                        <span class="badge ms-1" style="background: linear-gradient(135deg, #D4A017, #B8860B); color: #fff; font-size: 0.7em;"><i class="bi bi-award"></i> Trusted Seller</span>
                        {% endif %}
                        {% if listing.seller.profile.is_founding_member %}
                        <span class="badge ms-1" style="background: linear-gradient(135deg, #1a1a2e, #16213e); color: #e0e0e0; font-size: 0.7em;"><i class="bi bi-gem"></i> Founding Collector</span>
                        {% endif %}
                        <div class="d-flex align-items-center gap-3 mt-1">
                            {% if listing.seller.profile.rating %}
                            <span class="small">
                                <i class="bi bi-star-fill" style="color: #FBBF24;"></i>
                                {{ listing.seller.profile.rating|floatformat:1 }}
                                <span class="text-muted">({{ listing.seller.profile.rating_count }} reviews)</span>
                            </span>
                            {% endif %}
                            <span class="small text-muted">
                                {{ listing.seller.listings.count }} listings
                            </span>
                        </div>
                    </div>
                    <a href="{% url 'accounts:profile' username=listing.seller.username %}" class="btn btn-outline-dark btn-sm">
                        View Profile
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Item Details -->
            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">Item Details</h6>
                    <table class="detail-table">
                        <tr>
                            <th>Condition</th>
                            <td>{{ listing.get_condition_display }}</td>
                        </tr>
                        {% if listing.grading_service %}
                        <tr>
                            <th>Grading Service</th>
                            <td>{{ listing.grading_service|upper }}</td>
                        </tr>
                        <tr>
                            <th>Grade</th>
                            <td>{{ listing.grade }}</td>
                        </tr>
                        {% if listing.cert_number %}
                        <tr>
                            <th>Cert Number</th>
                            <td>{{ listing.cert_number }}</td>
                        </tr>
                        {% endif %}
                        {% endif %}
                        <tr>
                            <th>Category</th>
                            <td><a href="{{ listing.category.get_absolute_url }}" class="text-decoration-none">{{ listing.category.name }}</a></td>
                        </tr>
                        {% if listing.ships_from %}
                        <tr>
                            <th>Ships From</th>
                            <td>{{ listing.ships_from }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Listed</th>
                            <td>{{ listing.created|date:"M d, Y" }}</td>
                        </tr>
                        <tr>
                            <th>Views</th>
                            <td>{{ listing.views|intcomma }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Buyer Protection -->
            <div class="card" style="background: var(--gray-50); border: none;">
                <div class="card-body">
                    <div class="d-flex align-items-start gap-3">
                        <div class="flex-shrink-0">
                            <i class="bi bi-shield-check fs-4" style="color: var(--accent-success);"></i>
                        </div>
                        <div>
                            <h6 class="fw-bold mb-1">Buyer Protection</h6>
                            <p class="small text-muted mb-0">All purchases are protected. Get your item as described or your money back.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sell CTA -->
            {% if not user.is_authenticated or user != listing.seller %}
            <div class="card mt-3" style="background: var(--gray-900); border: none;">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="fw-bold mb-0 text-white">Have one like this?</h6>
                            <p class="small mb-0" style="color: var(--gray-400);">List yours on HeroesAndMore and reach thousands of collectors.</p>
                        </div>
                        {% if user.is_authenticated %}
                        <a href="{% url 'marketplace:listing_create' %}?from_listing={{ listing.pk }}" class="btn btn-light btn-sm flex-shrink-0 ms-3">
                            Sell Yours
                        </a>
                        {% else %}
                        <a href="{% url 'account_signup' %}?next={% url 'marketplace:listing_create' %}%3Ffrom_listing%3D{{ listing.pk }}" class="btn btn-light btn-sm flex-shrink-0 ms-3">
                            Sell Yours
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Description & Comments -->
    <div class="row mt-5">
        <div class="col-lg-8">
            <!-- Description -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Description</h5>
                    <div style="white-space: pre-wrap; line-height: 1.7; color: var(--gray-700);">{{ listing.description }}</div>

                    {% if listing.collector_notes %}
                    <div class="mt-3 p-3" style="background: linear-gradient(135deg, rgba(212,160,23,0.08), rgba(184,134,11,0.04)); border-left: 3px solid var(--brand-gold); border-radius: 0.5rem;">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <i class="bi bi-chat-quote" style="color: var(--brand-gold); font-size: 0.9rem;"></i>
                            <span class="fw-semibold" style="font-size: 0.8rem; color: var(--brand-gold); text-transform: uppercase; letter-spacing: 0.05em;">Collector Notes</span>
                        </div>
                        <p class="mb-0" style="font-style: italic; color: var(--gray-700); font-size: 0.95rem;">{{ listing.collector_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Comments Section -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Questions & Comments</h5>
                        <span class="badge bg-dark">{{ listing.comments.count }}</span>
                    </div>

                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'social:add_comment' listing_pk=listing.pk %}" class="mb-4">
                        {% csrf_token %}
                        <div class="d-flex gap-3">
                            {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                            {% else %}
                            <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background: var(--gray-200);">
                                <span style="font-weight: 600; color: var(--gray-600);">{{ user.username|slice:":1"|upper }}</span>
                            </div>
                            {% endif %}
                            <div class="flex-grow-1">
                                <textarea name="content" class="form-control mb-2" rows="2" placeholder="Ask a question or leave a comment..." required></textarea>
                                <button type="submit" class="btn btn-dark btn-sm">Post Comment</button>
                            </div>
                        </div>
                    </form>
                    {% endif %}

                    <div class="comments-list">
                        {% for comment in listing.comments.all %}
                        <div class="d-flex gap-3 {% if not forloop.last %}mb-4 pb-4 border-bottom{% endif %}">
                            {% if comment.author.profile.avatar %}
                            <img src="{{ comment.author.profile.avatar.url }}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                            {% else %}
                            <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 40px; height: 40px; background: var(--gray-200);">
                                <span style="font-weight: 600; color: var(--gray-600);">{{ comment.author.username|slice:":1"|upper }}</span>
                            </div>
                            {% endif %}
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <a href="{% url 'accounts:profile' username=comment.author.username %}" class="fw-semibold text-decoration-none">
                                            {{ comment.author.username }}
                                        </a>
                                        {% if comment.author == listing.seller %}
                                        <span class="badge bg-dark ms-1" style="font-size: 0.65rem;">Seller</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ comment.created|timesince }} ago</small>
                                </div>
                                <p class="mb-0 mt-1" style="color: var(--gray-700);">{{ comment.content }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="bi bi-chat-dots display-4 text-muted"></i>
                            <p class="text-muted mt-2 mb-0">No comments yet. Be the first to ask a question!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            {% if seller_listings %}
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold mb-0">More from {{ listing.seller.username }}</h6>
                        <a href="{% url 'accounts:profile' username=listing.seller.username %}" class="small">View all</a>
                    </div>
                    <div class="row g-2">
                        {% for item in seller_listings|slice:":4" %}
                        <div class="col-6">
                            {% include 'components/listing_card.html' with listing=item %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if related %}
            <div class="card">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">Similar Items</h6>
                    <div class="row g-2">
                        {% for item in related|slice:":4" %}
                        <div class="col-6">
                            {% include 'components/listing_card.html' with listing=item %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Sticky Bid Bar (auction only, authenticated non-seller) -->
{% if listing.listing_type == 'auction' and not listing.is_auction_ended and user.is_authenticated and user != listing.seller %}
<div class="sticky-bid-bar" id="stickyBidBar">
    <div class="container">
        <form method="post" action="{% url 'marketplace:place_bid' pk=listing.pk %}" class="d-flex align-items-center gap-3">
            {% csrf_token %}
            <div class="d-none d-md-block">
                <span class="text-muted small">Current:</span>
                <strong style="color: var(--brand-primary);">${{ listing.get_current_price|intcomma }}</strong>
            </div>
            {% if auction_end_iso %}
            <div class="d-none d-md-block">
                <span class="countdown-timer py-1 px-2" style="font-size: 0.8rem;" id="stickyCountdown" data-auction-end="{{ auction_end_iso }}">
                    <i class="bi bi-clock"></i>
                    <span id="stickyCountdownText"></span>
                </span>
            </div>
            {% endif %}
            <div class="input-group ms-auto" style="max-width: 300px;">
                <span class="input-group-text">$</span>
                <input type="number" name="amount" id="stickyBidAmount" class="form-control" step="0.01"
                       min="{{ listing.get_current_price|add:1 }}" placeholder="Max bid" required>
                <button type="submit" class="btn btn-dark fw-semibold">Place Bid</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<!-- Zoom Lightbox -->
<div class="zoom-overlay" id="zoomOverlay">
    <button class="zoom-close" onclick="closeZoom()" aria-label="Close">&times;</button>
    {% if listing.get_images|length > 1 %}
    <button class="zoom-nav zoom-prev" onclick="zoomNav(-1)" aria-label="Previous"><i class="bi bi-chevron-left"></i></button>
    <button class="zoom-nav zoom-next" onclick="zoomNav(1)" aria-label="Next"><i class="bi bi-chevron-right"></i></button>
    {% endif %}
    <img id="zoomImage" src="" alt="{{ listing.title }}">
    <div class="zoom-hint">Scroll to zoom &middot; Drag to pan &middot; Esc to close</div>
</div>

<!-- Offer Modal -->
{% if listing.allow_offers %}
<div class="modal fade" id="offerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" action="{% url 'marketplace:make_offer' pk=listing.pk %}">
                {% csrf_token %}
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Make an Offer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Current listing price: <strong class="text-dark">${{ listing.price|intcomma }}</strong></p>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Your Offer</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">$</span>
                            <input type="number" name="amount" class="form-control" step="0.01" min="1" placeholder="0.00" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Message to Seller (optional)</label>
                        <textarea name="message" class="form-control" rows="3" placeholder="Add a note with your offer..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-dark">Submit Offer</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// TikTok Pixel: ViewContent
if (typeof ttq !== 'undefined') {
    ttq.track('ViewContent', {
        content_id: '{{ listing.pk }}',
        content_type: 'product',
        content_name: '{{ listing.title|escapejs }}',
        price: {{ listing.get_current_price|floatformat:2 }},
        currency: 'USD'
    });
}
// TikTok Pixel: AddToCart on bid
var bidForm = document.getElementById('bidForm');
if (bidForm) {
    bidForm.addEventListener('submit', function() {
        if (typeof ttq !== 'undefined') {
            var amt = document.getElementById('bidAmount').value;
            ttq.track('AddToCart', {
                content_id: '{{ listing.pk }}',
                content_type: 'product',
                content_name: '{{ listing.title|escapejs }}',
                price: parseFloat(amt) || 0,
                currency: 'USD'
            });
        }
    });
}
// TikTok Pixel: AddToWishlist on save
document.addEventListener('htmx:afterRequest', function(e) {
    if (e.detail.pathInfo && e.detail.pathInfo.requestPath.includes('/save/')) {
        if (typeof ttq !== 'undefined') {
            ttq.track('AddToWishlist', {
                content_id: '{{ listing.pk }}',
                content_type: 'product',
                content_name: '{{ listing.title|escapejs }}',
                price: {{ listing.get_current_price|floatformat:2 }},
                currency: 'USD'
            });
        }
    }
});
</script>
<script>
function switchImage(thumb, imageUrl) {
    document.getElementById('mainImage').src = imageUrl;
    document.querySelectorAll('.thumbnail-item').forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
}

// Multi-quantity Buy Now
(function() {
    var qtyInput = document.getElementById('buy-qty');
    var buyBtn = document.getElementById('buy-now-btn');
    if (qtyInput && buyBtn) {
        var baseUrl = buyBtn.href;
        var unitPrice = {{ listing.price }};
        qtyInput.addEventListener('change', updateBuyBtn);
        qtyInput.addEventListener('input', updateBuyBtn);
        function updateBuyBtn() {
            var qty = parseInt(qtyInput.value) || 1;
            var max = parseInt(qtyInput.max) || 1;
            if (qty < 1) { qty = 1; qtyInput.value = 1; }
            if (qty > max) { qty = max; qtyInput.value = max; }
            var total = (unitPrice * qty).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            buyBtn.href = baseUrl + '?qty=' + qty;
            buyBtn.innerHTML = '<i class="bi bi-bag me-2"></i> Buy Now — $' + total;
        }
    }
})();

// Quick Bid Buttons
(function() {
    var currentPrice = {{ listing.get_current_price }};
    var btns = document.querySelectorAll('.quick-bid-btn');
    var bidInput = document.getElementById('bidAmount');
    var stickyInput = document.getElementById('stickyBidAmount');

    btns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            var inc = parseInt(this.getAttribute('data-increment'));
            var val = currentPrice + inc;
            if (bidInput) bidInput.value = val;
            if (stickyInput) stickyInput.value = val;
        });
    });

    // Sync bid inputs bidirectionally
    if (bidInput && stickyInput) {
        bidInput.addEventListener('input', function() { stickyInput.value = this.value; });
        stickyInput.addEventListener('input', function() { bidInput.value = this.value; });
    }
})();

// Sticky Bid Bar
(function() {
    var bidForm = document.getElementById('bidForm');
    var stickyBar = document.getElementById('stickyBidBar');
    if (!bidForm || !stickyBar) return;

    var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                stickyBar.classList.remove('visible');
            } else {
                stickyBar.classList.add('visible');
            }
        });
    }, { threshold: 0 });
    observer.observe(bidForm);
})();

// Countdown Timer
(function() {
    var timerEl = document.getElementById('countdownTimer');
    var countdownSpan = document.getElementById('countdown');
    var stickyTimerEl = document.getElementById('stickyCountdown');
    var stickySpan = document.getElementById('stickyCountdownText');

    if (!timerEl) return;
    var endStr = timerEl.getAttribute('data-auction-end');
    if (!endStr) return;
    var endTime = new Date(endStr).getTime();

    function tick() {
        var now = new Date().getTime();
        var diff = endTime - now;
        if (diff <= 0) {
            if (countdownSpan) countdownSpan.textContent = 'Ended';
            if (stickySpan) stickySpan.textContent = 'Ended';
            return;
        }
        var d = Math.floor(diff / 86400000);
        var h = Math.floor((diff % 86400000) / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        var s = Math.floor((diff % 60000) / 1000);
        var text;
        if (d > 0) text = d + 'd ' + h + 'h ' + m + 'm ' + s + 's';
        else if (h > 0) text = h + 'h ' + m + 'm ' + s + 's';
        else if (m > 0) text = m + 'm ' + s + 's';
        else text = s + 's';

        if (countdownSpan) countdownSpan.textContent = text;
        if (stickySpan) stickySpan.textContent = text;

        // Urgency classes
        if (diff < 10000) {
            timerEl.classList.add('urgency-critical');
            timerEl.classList.remove('urgency-warning');
            if (stickyTimerEl) {
                stickyTimerEl.classList.add('urgency-critical');
                stickyTimerEl.classList.remove('urgency-warning');
            }
        } else if (diff < 60000) {
            timerEl.classList.add('urgency-warning');
            timerEl.classList.remove('urgency-critical');
            if (stickyTimerEl) {
                stickyTimerEl.classList.add('urgency-warning');
                stickyTimerEl.classList.remove('urgency-critical');
            }
        }
    }

    tick();
    setInterval(tick, 1000);
})();

// Image Zoom
(function() {
    var overlay = document.getElementById('zoomOverlay');
    var zoomImg = document.getElementById('zoomImage');
    var mainContainer = document.getElementById('mainImageContainer');
    var scale = 1, panX = 0, panY = 0;
    var isDragging = false, startX = 0, startY = 0;
    var images = [{% for img in listing.get_images %}'{{ img.url }}'{% if not forloop.last %},{% endif %}{% endfor %}];
    var currentIdx = 0;

    if (mainContainer) {
        mainContainer.addEventListener('click', function() {
            var mainImg = document.getElementById('mainImage');
            if (!mainImg) return;
            currentIdx = images.indexOf(mainImg.src.replace(location.origin, ''));
            if (currentIdx < 0) currentIdx = 0;
            openZoom(images[currentIdx]);
        });
    }

    function openZoom(src) {
        zoomImg.src = src;
        scale = 1; panX = 0; panY = 0;
        applyTransform();
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    window.closeZoom = function() {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    };

    window.zoomNav = function(dir) {
        currentIdx = (currentIdx + dir + images.length) % images.length;
        scale = 1; panX = 0; panY = 0;
        zoomImg.src = images[currentIdx];
        applyTransform();
    };

    function applyTransform() {
        zoomImg.style.transform = 'translate(' + panX + 'px, ' + panY + 'px) scale(' + scale + ')';
    }

    // Mouse wheel zoom
    overlay.addEventListener('wheel', function(e) {
        e.preventDefault();
        var delta = e.deltaY > 0 ? -0.15 : 0.15;
        scale = Math.min(Math.max(scale + delta, 0.5), 5);
        if (scale <= 1) { panX = 0; panY = 0; }
        applyTransform();
    }, {passive: false});

    // Mouse drag
    overlay.addEventListener('mousedown', function(e) {
        if (e.target === zoomImg && scale > 1) {
            isDragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
            overlay.style.cursor = 'grabbing';
        }
    });
    overlay.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        panX = e.clientX - startX;
        panY = e.clientY - startY;
        applyTransform();
    });
    overlay.addEventListener('mouseup', function() {
        isDragging = false;
        overlay.style.cursor = 'grab';
    });

    // Touch pinch-to-zoom
    var lastDist = 0, lastMidX = 0, lastMidY = 0;
    overlay.addEventListener('touchstart', function(e) {
        if (e.touches.length === 1 && scale > 1) {
            isDragging = true;
            startX = e.touches[0].clientX - panX;
            startY = e.touches[0].clientY - panY;
        } else if (e.touches.length === 2) {
            isDragging = false;
            lastDist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
        }
    }, {passive: true});
    overlay.addEventListener('touchmove', function(e) {
        if (e.touches.length === 1 && isDragging) {
            e.preventDefault();
            panX = e.touches[0].clientX - startX;
            panY = e.touches[0].clientY - startY;
            applyTransform();
        } else if (e.touches.length === 2) {
            e.preventDefault();
            var dist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
            var delta = (dist - lastDist) * 0.01;
            scale = Math.min(Math.max(scale + delta, 0.5), 5);
            lastDist = dist;
            if (scale <= 1) { panX = 0; panY = 0; }
            applyTransform();
        }
    }, {passive: false});
    overlay.addEventListener('touchend', function() { isDragging = false; });

    // Click overlay background to close (not the image)
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closeZoom();
    });

    // Keyboard controls
    document.addEventListener('keydown', function(e) {
        if (!overlay.classList.contains('active')) return;
        if (e.key === 'Escape') closeZoom();
        else if (e.key === 'ArrowLeft' && images.length > 1) zoomNav(-1);
        else if (e.key === 'ArrowRight' && images.length > 1) zoomNav(1);
    });
})();
</script>
{% endblock %}
