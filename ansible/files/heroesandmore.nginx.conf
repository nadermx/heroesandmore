upstream heroesandmore_app {
    server unix:/tmp/heroesandmore.sock fail_timeout=0;
}

server {
    listen 80;
    server_name heroesandmore.com www.heroesandmore.com;

    # Redirect HTTP to HTTPS (canonical)
    return 301 https://heroesandmore.com$request_uri;
}

# Redirect www to non-www
server {
    listen 443 ssl http2;
    server_name www.heroesandmore.com;

    ssl_certificate /etc/letsencrypt/live/heroesandmore.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/heroesandmore.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://heroesandmore.com$request_uri;
}

server {
    listen 443 ssl http2;
    server_name heroesandmore.com;

    # SSL configuration (managed by certbot)
    ssl_certificate /etc/letsencrypt/live/heroesandmore.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/heroesandmore.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    client_max_body_size 2G;

    # Increase timeouts for large video uploads
    proxy_read_timeout 600s;
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;

    location /static/ {
        alias /home/www/heroesandmore/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /media/ {
        alias /home/www/heroesandmore/media/;
        expires 7d;
    }

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_pass http://heroesandmore_app;
    }

    # Health check endpoint
    location /health/ {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    ### CLICKY ANTI-ADBLOCK PROXY - https://clicky.com/help/proxy

    # DNS RESOLVER
    resolver 1.1.1.1;

    # COOKIES - override cookie header to just send the service-related first party cookies.
    set $cookie "";
    if ($cookie__cky_ignore) {
        set $cookie "_cky_ignore=$cookie__cky_ignore; _cky_osa=$cookie__cky_osa";
    }

    # JAVASCRIPT TRACKING CODE
    location = /a91abe04d0a26f18d7.js {
        proxy_pass https://static.getclicky.com/js?in=%2Fa48874aa7ba6c59a81;
        proxy_connect_timeout 10s;
        proxy_http_version 1.1;
        proxy_ssl_server_name on;
        proxy_set_header Host static.getclicky.com;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie "";
    }

    # JAVASCRIPT BEACON
    location = /a48874aa7ba6c59a81 {
        proxy_pass https://in.getclicky.com/in.php;
        proxy_connect_timeout 10s;
        proxy_http_version 1.1;
        proxy_ssl_server_name on;
        proxy_set_header Host in.getclicky.com;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $cookie;
    }
}
